<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pay School Fees</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .header-nav { background-color: #28a745; }
        .section-card { background-color: white; }
        .btn-primary { background-color: #28a745; }
        .btn-primary:hover { background-color: #218838; }
        .input-field { border-color: #d1d5db; }
        .input-field:focus { border-color: #28a745; box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #28a745; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">
    <header class="header-nav text-white shadow-lg"><div class="container mx-auto p-4 flex justify-between items-center"><a href="student-dashboard.html" class="flex items-center gap-2 hover:bg-white/10 p-2 rounded-lg transition"><i data-lucide="arrow-left" class="w-5 h-5"></i><span class="font-semibold">Back to Dashboard</span></a><h1 class="text-2xl font-bold">School Fees Payment</h1></div></header>
    <main class="container mx-auto p-4 md:p-8">
        <div id="loadingState" class="text-center py-20"><div class="loader mx-auto"></div><p class="mt-4 text-gray-500">Loading your financial details...</p></div>
        <div id="mainContent" class="hidden max-w-2xl mx-auto">
            <div class="section-card p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-6"><h2 class="text-3xl font-bold text-gray-900">Pay Your Fees</h2><p class="text-gray-500 mt-1">Settle your outstanding school fees securely online.</p></div>
                <div class="bg-gray-50 p-6 rounded-xl border mb-8 space-y-4"><div class="flex justify-between items-center"><span class="text-gray-600">Total Fees Due:</span><span id="totalFees" class="font-bold text-lg">₦0.00</span></div><div class="flex justify-between items-center"><span class="text-gray-600">Amount Paid:</span><span id="amountPaid" class="font-bold text-lg text-green-600">₦0.00</span></div><hr class="border-dashed"><div class="flex justify-between items-center"><span class="font-semibold text-lg">Balance Remaining:</span><span id="balanceDue" class="font-bold text-xl text-red-600">₦0.00</span></div></div>
                <div class="space-y-4">
                    <div><label for="paymentAmount" class="block text-sm font-medium text-gray-600 mb-1">Amount to Pay (₦)</label><input type="number" id="paymentAmount" placeholder="Enter amount" class="input-field w-full p-4 rounded-lg text-lg font-semibold"></div>
                    <button id="payBtn" class="btn-primary w-full text-white font-bold py-4 px-6 rounded-lg transition text-lg flex items-center justify-center gap-2" disabled><span>Proceed to Payment</span><i data-lucide="lock" class="w-5 h-5"></i></button>
                    <p id="paymentError" class="text-center text-sm text-red-500 h-5"></p>
                </div>
            </div>
        </div>
    </main>

<script>
const SUPABASE_URL = 'https://lxjclssfgqalcpilheet.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4amNsc3NmZ3FhbGNwaWxoZWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDQwNTYsImV4cCI6MjA3MzM4MDA1Nn0.y-AY6DnfINAEl9jcNXoq32l7CyNEBp0o-Ne-Fniwais';
const PAYSTACK_PUBLIC_KEY = 'YOUR_PAYSTACK_PUBLIC_KEY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const formatCurrency = (amount) => new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(amount);

class FeesManager {
    constructor() { this.student = null; this.balanceDue = 0; this.paymentAmount = 0; }
    async initialize() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = 'student-signin.html'; return; }
        try {
            const { data, error } = await supabase.rpc('get_student_financials', { student_id: session.user.id }).single();
            if (error) throw error;
            this.student = { ...data, id: session.user.id }; // Add user ID to student object
            this.balanceDue = parseFloat(data.balance_due);
            this.render();
            this.setupEventListeners();
        } catch (error) { document.getElementById('loadingState').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; }
    }
    render() {
        document.getElementById('totalFees').textContent = formatCurrency(this.student.total_fees_due);
        document.getElementById('amountPaid').textContent = formatCurrency(this.student.fees_paid);
        const balanceDisplay = document.getElementById('balanceDue');
        balanceDisplay.textContent = formatCurrency(this.balanceDue > 0 ? this.balanceDue : 0);
        if (this.balanceDue <= 0) {
            balanceDisplay.classList.remove('text-red-600');
            balanceDisplay.classList.add('text-green-600');
        }
        const paymentAmountInput = document.getElementById('paymentAmount');
        if (this.balanceDue > 0) {
            paymentAmountInput.value = this.balanceDue;
            this.paymentAmount = this.balanceDue;
        } else {
            paymentAmountInput.value = '';
            paymentAmountInput.placeholder = 'Fees fully paid';
            paymentAmountInput.disabled = true;
        }
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        lucide.createIcons();
        this.checkCanPay();
    }
    setupEventListeners() {
        document.getElementById('paymentAmount').addEventListener('input', (e) => { this.paymentAmount = parseFloat(e.target.value) || 0; this.checkCanPay(); });
        document.getElementById('payBtn').addEventListener('click', () => this.startPaystackPayment());
    }
    checkCanPay() {
        const payBtn = document.getElementById('payBtn');
        const paymentError = document.getElementById('paymentError');
        paymentError.textContent = '';
        if (this.balanceDue <= 0) { payBtn.disabled = true; return; }
        if (this.paymentAmount <= 0) { payBtn.disabled = true; }
        else if (this.paymentAmount > this.balanceDue) { payBtn.disabled = true; paymentError.textContent = 'Payment cannot exceed the balance due.'; }
        else { payBtn.disabled = false; }
    }
    startPaystackPayment() {
        if (PAYSTACK_PUBLIC_KEY === 'YOUR_PAYSTACK_PUBLIC_KEY') { Swal.fire('Configuration Error', 'Paystack has not been configured.', 'error'); return; }
        const handler = PaystackPop.setup({
            key: PAYSTACK_PUBLIC_KEY,
            email: this.student.email,
            amount: this.paymentAmount * 100,
            currency: 'NGN',
            ref: `STU_${this.student.admission_number || 'NA'}_${Date.now()}`,
            metadata: { student_id: this.student.id }, // Pass the student's user ID
            callback: (response) => { this.verifyPaymentWithBackend(response.reference); },
            onClose: () => { Swal.fire('Cancelled', 'You have cancelled the payment process.', 'info'); }
        });
        handler.openIframe();
    }
    async verifyPaymentWithBackend(reference) {
        Swal.fire({ title: 'Verifying Payment...', text: 'Please wait, do not close this page.', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
        try {
            const { data, error } = await supabase.functions.invoke('verify-school-fees', { body: { reference } });
            if (error || data.error) throw error || new Error(data.error);
            
            const amountPaidInThisTransaction = data.amountPaid;
            // After successful payment, re-fetch all data to get the latest balance
            await this.initialize(); 
            Swal.fire('Payment Successful!', `Your payment of ${formatCurrency(amountPaidInThisTransaction)} was successful.`, 'success');
        } catch (error) { Swal.fire('Verification Failed', error.message, 'error'); }
    }
}
document.addEventListener('DOMContentLoaded', () => { const page = new FeesManager(); page.initialize(); });
</script>
</body>
</html>